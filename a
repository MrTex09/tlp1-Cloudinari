// Configuraci칩n de multer para la subida de archivos
const storage = multer.diskStorage({
  destination: "uploads/",
  filename: function (req, file, cb) {
    cb(null, Date.now() + "." + path.extname(file.originalname));
  },
});

const upload = multer({
  storage: storage,
});

// Configuraci칩n de la vista y el motor de plantillas EJS
app.set("view engine", "ejs");
app.set("views", path.join(__dirname, "views"));

// Ruta para la p치gina de inicio
app.get("/", (req, res) => {
  res.render("upload", { error: null, success: null });
});

cloudinary.config({
  cloud_name: "diqttuxad",
  api_key: 852866145688219,
  api_secret: "kh9uplQr4aLbXklD7b7Cicoimwc",
});

// Ruta para la subida de archivos
app.post("/files", upload.single("avatar"), async (req, res) => {
  if (!req.file) {
    res.render("upload", {
      error: "Por favor, selecciona un archivo para subir.",
      success: null,
    });
  } else {
    let error, uploadedFile;
    try {
      uploadedFile = await cloudinary.uploader.upload(
        path.join(__dirname, "./uploads", req.file.filename),
        {
          folder: "upload",
        }
      );
    } catch (err) {
      error = err;
    }

    res.render("upload", {
      error: JSON.stringify(error) || null,
      success:
        !error && "Archivo subido exitosamente. URL: " + uploadedFile.url,
    });
  }
});

// Manejo de errores
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).send("Ocurri칩 un error.");
});
